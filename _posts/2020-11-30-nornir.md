---
layout: post
title: Nornir
tags: [ python, automation, nornir, napalm, ]
image: /img/nornir_logo.png
---

Over the last few weeks, I have been working with Nornir, described as a 'Pluggable multi-threaded framework with inventory management to help operate collections of devices'. I looked into it hoping to find something lightweight that would just 'get the job done'.

It did not disappoint.

{:refdef: style="text-align: center;"}
![Nornir logo](/img/nornir_logo_big.jpg "Nornir logo")
{: refdef}

# Nornir

In Nornir, you can run tasks against a collection of devices that are organized in its inventory. Nornir is written in Python. And not only is Nornir written in Python, everything you do in Nornir is done in Python. This means that instead of working with a DSL, you express yourself in Python. 

Nornir allows you to work with everything that is available in the Python ecosystem. After by pip installing it, you are good to go. And not only can you make use of all the usual suspects, you are not bound or limited in any way from using whatever other packages you are fond of. 

Additionally, all flow control and debugging is done in Python. In my opinion, this is a lot cleaner and better when compared to what most DSLs have to offer. 

The thing I really like about Nornir is the fact that it is so <b>minimal</b> and to the point. There are very little constructs you have to worry about. As soon as you understand the basic mechanics, you are good to go. 


# Nornir: getting started

The best way to better understand Nornir is to create and run a few tasks yourself. First, let's install Nornir and the NAPALM plugin:

```
pip3 install nornir
pip3 install nornir_napalm
```

Before we can run any task in Nornir, we need to have an inventory. The inventory is where the characteristics of devices Nornir needs to touch are defined. Nornir allows you to interface with external systems and use that data to programmatically build an inventory. It also ships with a <b>SimpleInventory</b>, which is what we'll use in this example. Using the SimpleInventory, we need to define three YAML files for the following:
- hosts
- groups
- defaults


The hosts define the devices that Nornir can target. We can define elaborate characteristics for every host, but in this example, we will stick to the basics:

```yaml
veos01:
  hostname: 10.254.169.50
  groups:
    - arista_eapi
veos02:
  hostname: 10.254.169.51
  groups:
    - arista_eapi
```

We defined 2 hosts: <b>veos01</b> and <b>veos02</b>. We specified an IP address and we signified group membership. Inside the groups, we can define attributes that hosts will inherit.

The following is a groups file that will put in pace the defaults that will allow you to manage devices using the NAPALM plugin:

```yaml
juniper: { platform: junos, port: 830 }
arista: { platform: eos, port: 22 }
arista_eapi: { platform: eos, port: 443}
cisco_ios: { platform: ios, port: 22 }
cisco_nxos: { platform: nxos, port: 22 }
```

We assigned the hosts to the <b>arista_eapi</b> group. This means that the hosts will be of the platform 'eos' and they will use port '443'. 

Lastly, our example also requires a <b>defaults</b>:

```yaml
username: admin
password: password
```

The characteristics defined in the defaults are added to every device. Host or groups characteristics take precedence. So in case you want to have <b>juniper</b> group use a different password, you could overwrite the default password at the group level.

The groups and defaults can be used for more than just instructions on how to connect to devices. They are a nice construct to use to describe your infrastructure on a more abstract level and have that data available at runtime inside a task when you execute the script. You could create groups for datacenters and assign every datacenter with an AS, a syslog IP, management subnets etc. Doing so allows you to use that information for a variety of reasons. Two important things this information could be used for are targeting and templating.

# Example script

In this section, I am breaking down the example script found [here](https://github.com/saidvandeklundert/nornir/blob/main/nornir_example.py).

In summary, this script will do the following:
- initialize Nornir
- run a task against the devices that are targeted

Initializing Nornir means loading the inventory data and preparing Nornir to execute the main task. A task is a function that is executed against the devices targeted by Nornir. In our example, the main task is setup to run 7 subtasks against the devices that are targeted. 

The first subtasks should help you understand how Nornir does what it does. The tasks explain how to log something, pass arguments and inspect some objects relevant to working with Nornir.

The second part of the subtasks illustrate to perform various operations using the NAPALM plugin. We will send a command, use a NAPALM getter and finish up configuring a device.


## Initializing Nornir

The following function can be called to initialize the Nornir object:

```python
def get_nornir_cfg():
    """
    Returns the Nornir object.
    """
    InventoryPluginRegister.register("SimpleInventory", SimpleInventory)
    nr = InitNornir(
        runner={
            "plugin": "threaded",
            "options": {
                "num_workers": 100,
            },
        },
        inventory={
            "plugin": "SimpleInventory",
            "options": {
                    "host_file": "/inventory/hosts.yaml",
                    "group_file": "/inventory/groups.yaml",
                    "defaults_file": "/inventory/defaults.yaml"
            },
        }
    )
    return nr

```

This will return a Nornir object. This object can be used to run a task against the hosts defined in the inventory. The task will be threaded using 100 workers.

The following shows how we can first construct the <b>nr</b> object and then run a task called <b>main_task</b> against all the devices. We finish up printing the result of the task using <b>print_result</b>

```python
if __name__ == "__main__":

    
    nr = get_nornir_cfg()

    result = nr.run(
        name="Task example and explanation function.",
        task=main_task,
        example_arg_1="arg_1",
        example_arg_2="arg_2",
        template_string=template_string
    )

    print_result(result)
```

## Tasks and subtasks

The previous code runs the <b>main_task</b> against all the hosts in the inventory. The main task is defined as follows:

```python
def main_task(task: Task, example_arg_1, example_arg_2, template_string) -> Result:
    """
    This is the main task or function of the program. 
    
    We will call several sub tasks from this task.
    """
    
    task.run(
        name="Logging example.",
        task=log_something,
    )
    
    task.run(
        name="example_task",
        task=example_task,
        example_arg_1=example_arg_1,
        example_arg_2=example_arg_2,
    )
    
    result_to_examine = task.run(
        name="examine task",
        task=examine_task,
    )

    task.run(
        name="examine result",
        task=examine_result,
        result = result_to_examine        
    )    
    
    task.run(
        name="example command using NAPALM",
        task=example_command_using_napalm,
    )
    
    task.run(
        name="example using NAPALM getters",
        task=example_napalm_getters,
    )

    task.run(
        name="example configuration using NAPALM",
        task=example_napalm_configure,
        template_string=template_string,        
    )

    return Result(
        host=task.host,
        result="Example task finished!",
    )
```

The main task shown here will run the defined sub-tasks against the hosts that are targeted by the script. The first 4 subtasks aim to illustrate how Nornir works. The tasks after that illustrate a few operations using the NAPALM plugin.

### Nornir illustration functions


The first subtask that is called in the main task will log a message. The subtask is defined in the following code:

```python
logger = logging.getLogger('nornir')


def log_something(task: Task,) -> Result:
    """
    Nornir will log to 'nornir.log' by default.
    """    
    logger.info(f"{task.host.name} says hi!")
    logger.warning("Warning %r is running task %r", task.host.name, task.name)    
    return Result(
        host=task.host,
        result=f"Task {task.name} made some log updates"
    )
```

The first line grabs the default logger used in Nornir. You can use this to output messages to the <b>nornir.log</b> file that is used by default. Next is the function that defines the subtask. The function logs 2 messages and then returns a result. When we run the example script, we will see the following appear on screen for every host:

```
---- Logging example. ** changed : False --------------------------------------- INFO
Task Logging example. made some log updates
```

After running the script, we can see veos01 logged the following to <b>nornir.log</b>:

```
2020-11-28 20:10:03,769 -       nornir -     INFO - log_something() - veos01 sayd hi
2020-11-28 20:10:03,770 -       nornir -  WARNING - log_something() - Warning 'veos01' is running task 'Logging example.'
```

The subtasks run after the logging task do the following:
- pass additional arguments to a subtask
- inspect the task object
- inspect the result object

```python
def example_task(task: Task, example_arg_1, example_arg_2) -> Result:
    """
    This is an example sub-task that can be used in a Nornir main task.

    Purpose of this task it to return the example arguments.
    """
    task_result = f"Got the following:\nexample_arg_1: {example_arg_1}\nexample_arg_2: {example_arg_2}"
    return Result(
        host=task.host,
        result=task_result
    )


def examine_task(task: Task,) -> Result:
    """
    This task will return information that describes the task object.
    """
    ret_dict ={
        "task" : task,
        "task name" : task.name,
        "host dict" : task.host.dict(),
        "groups content" : task.host.groups[0].dict(),
        "default content" : task.host.defaults.dict(),
        "task methods" : dir(task),
        "host methods" : dir(task.host),
        "task type" : type(task),        
    }
    # to have a detailed look around, consider setting a trace by removing next line's comment:
    #import pdb; pdb.set_trace()
    return Result(
        host=task.host,
        result=ret_dict
    )


def examine_result(task: Task, result) -> Result:
    """
    This task will return information describing the result object.
    """
    ret_dict ={
        "result" : result,
        "result methods" : dir(result),
        "task type" : type(result),        
    }
    # to have a detailed look around, consider setting a trace by removing next line's comment:
    #import pdb; pdb.set_trace()
    return Result(
        host=task.host,
        result=ret_dict
    )
```

Since the output for there tasks is quite lengthy, I pasted the output [here](https://github.com/saidvandeklundert/nornir/blob/main/example_output.txt). A thing to point out in this last function is the way in which you can troubleshoot scripts that use Nornir. You can insert <b>import pdb; pdb.set_trace()</b> at any point in the code and have a look around to see what is happening.


### Nornir basic device handling


There are plugins available to Nornir that come with tasks that allow you to interface with a library that is not part of the Nornir core repo. The example script uses the several of the NAPALM tasks that `nornir_napalm` provides. The Nornir NAPALM repo can be found [here](https://github.com/nornir-automation/nornir_napalm).

Plugins are installed separately. To install the NAPALM plugin, we do the following:

```
pip install nornir_napalm
```

After this, you will be able to import the tasks into your scripts:

```python
from nornir_napalm.plugins.tasks import napalm_configure, napalm_cli, napalm_get
```

On to using the NAPALM tasks. The example script has three subtask that use the NAPALM plugin. The first subtask that uses the plugin is calling <b>napalm_cli</b> to send a few commands to a device:

```python
def example_command_using_napalm(task: Task,) -> Result:
    """
    Send commands using napalm_cli
    """
    cmd_ret = task.run(
        task=napalm_cli, commands=[
            'show version',
            'show hostname',
            ],
    )
    # In case you want to work with the returns for the individual commands, uncomment the following lines:
    #show_version_output = cmd_ret[0].result['show version']
    #config = cmd_ret[0].result['show hostname']

    return Result(
        host=task.host,
        result=cmd_ret
    )
```

The previous subtask will output the return of the command:

```
vvvv example command using NAPALM ** changed : False vvvvvvvvvvvvvvvvvvvvvvvvvvv INFO
MultiResult: [Result: "napalm_cli"]
---- napalm_cli ** changed : False --------------------------------------------- INFO
{ 'show hostname': 'Hostname: veos01\nFQDN:     veos01\n',
  'show version': ' vEOS\n'
                  'Hardware version:      \n'
                  'Serial number:         \n'
                  'Hardware MAC address:  444c.a809.182b\n'
                  'System MAC address:    444c.a809.182b\n'
                  '\n'
                  'Software image version: 4.24.1.1F\n'
                  'Architecture:           i686\n'
                  'Internal build version: 4.24.1.1F-17172302.42411F\n'
                  'Internal build ID:      '
                  'cf3ba327-e192-46b4-8e8e-4aeaee798dd2\n'
                  '\n'
                  'Uptime:                 12 weeks, 4 days, 16 hours and 41 '
                  'minutes\n'
                  'Total memory:           1872580 kB\n'
                  'Free memory:            1072492 kB\n'
                  '\n'}
^^^^ END example command using NAPALM ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
```

The main script then continues to run a subtask that let's you access the NAPALM getters:

```python
def example_napalm_getters(task: Task,) -> Result:
    """
    Example on how to use the NAPALM getters.

    There are a lot more getters, find them here:
        https://napalm.readthedocs.io/en/latest/support/
    """
    napalm_getters = task.run(
        task = napalm_get, getters=["get_facts"],
        )
    
    return Result(
        host=task.host,
        result=napalm_getters
    )
```

The getters you are interested are put in a list and then passed to the `napalm_get` task. In this example, we are retrieving the facts:

```
vvvv example using NAPALM getters ** changed : False vvvvvvvvvvvvvvvvvvvvvvvvvvv INFO
MultiResult: [Result: "napalm_get"]
---- napalm_get ** changed : False --------------------------------------------- INFO
{ 'get_facts': { 'fqdn': 'veos01',
                 'hostname': 'veos01',
                 'interface_list': [ 'Ethernet1',
                                     'Loopback0',
                                     'Management1',
                                     'Port-Channel1000',
                                     'Vlan4094'],
                 'model': 'vEOS',
                 'os_version': '4.24.1.1F-17172302.42411F',
                 'serial_number': '',
                 'uptime': 7660573,
                 'vendor': 'Arista'}}
^^^^ END example using NAPALM getters ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
```

The final example details how you can use the `napalm_configure` plugin:

```python
template_string = """
interface loopback 0
description Nornir
"""

def example_napalm_configure(task: Task, template_string) -> Result:
    """
    Example on how to use the NAPALM to configure devices.
        
    Since dry_run is set to True, this task will only retrieve a diff.

    In this example, Arista EOS is used.
    """
    
    napalm_ret = task.run(
        task=napalm_configure,
        configuration=template_string,
        dry_run=True
    )
    return Result(
        host=task.host,
        result=napalm_ret
    )
```

The task was passed a string in the main task. And because we set dry_run to `True`, we are not committing the configuration. We enter configure sessions, obtain a diff and perform a rollback. The task result will tell us whether or not applying the configuration will result in a change and what the actual change would look like:
These functions

```
vvvv example configuration using NAPALM ** changed : False vvvvvvvvvvvvvvvvvvvvv INFO
MultiResult: [Result: "napalm_configure"]
---- napalm_configure ** changed : True ---------------------------------------- INFO
@@ -41,6 +41,7 @@
    channel-group 1000 mode active
 !
 interface Loopback0
+   description Nornir
    ip address 5.5.5.5/32
 !
 interface Management1
^^^^ END example configuration using NAPALM ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
```


# Working with the result

Initially, the result left me a bit puzzled. I did not really understand the `AggregatedResult` and `MultiResult` you end up with after `nr.run`:

```python
    result = nr.run(
        name="Task example and explanation function.",
        task=main_task,
        example_arg_1="arg_1",
        example_arg_2="arg_2",
        template_string=template_string
    )
```

To better understand the <b>result</b>, I ran the script with `python -i`. This will enter interactive mode after executing the script. As we can see, the <b>result</b> is a dict-like object that shows us the results of all the hosts we ran the task against:

```python
>>> result
AggregatedResult (Task example and explanation function.): {'veos01': MultiResult: [Result: "Task example and explanation function.", Result: "Logging example.", Result: "example_task", Result: "examine task", Result: "examin result", MultiResult: [Result: "example command using NAPALM", Result: "napalm_cli"], MultiResult: [Result: "example using NAPALM getters", Result: "napalm_get"], MultiResult: [Result: "example configuration using NAPALM", Result: "napalm_configure"]], 'veos02': MultiResult: [Result: "Task example and explanation function.", Result: "Logging example.", Result: "example_task", Result: "examine task", Result: "examin result", MultiResult: [Result: "example command using NAPALM", Result: "napalm_cli"], MultiResult: [Result: "example using NAPALM getters", Result: "napalm_get"], MultiResult: [Result: "example configuration using NAPALM", Result: "napalm_configure"]]}
>>> 
```

Inside the aggregated result, we can find the results for all the individual hosts. To check what hosts we have a result for, we can look at the keys of the result:

```python
>>> result.keys()
dict_keys(['veos01', 'veos02'])
>>>
```

Supplying the hostname as key will lead to the result of an individual host. The result for an individual host is called <b>Multiresult</b>. This multiresult contains a list of the results for every subtask that was executed for the host.

```python
>>> type(result['veos01'])
nornir.core.task.MultiResult
>>> result['veos01']      
MultiResult: [Result: "Task example and explanation function.", Result: "Logging example.", Result: "example_task", Result: "examine task", Result: "examin result", MultiResult: [Result: "example command using NAPALM", Result: "napalm_cli"], MultiResult: [Result: "example using NAPALM getters", Result: "napalm_get"], MultiResult: [Result: "example configuration using NAPALM", Result: "napalm_configure"]]
>>>
```

We can access the result of a subtask by entering the index number. In the following example, we access the logging subtask and the NAPALM configure subtask:

```python
>>> result['veos01'][1]
Result: "Logging example."
>>> result['veos01'][7]
MultiResult: [Result: "example configuration using NAPALM", Result: "napalm_configure"]
>>> 
```

If we access an individual task, we can retrieve the parameters associated with the result of a task:

```python
>>> result['veos01'][1].result
'Task Logging example. some log updates'
>>> result['veos01'][1].failed
False
```

The task documentation should reflect what you can expect a task to return. In the above example, we could see the string that was returned in our example task. When we check the NAPALM plugin documentation for the configure function, we can see that it returns the following:

```
    Returns:
        Result object with the following attributes set:
          * changed (``bool``): whether the task is changing the system or not
          * diff (``string``): change in the system
```

This means that we should be able to retrieve these two values:

```python
>>> result['veos01'][7].result[0].diff  
'@@ -41,6 +41,7 @@\n    channel-group 1000 mode active\n !\n interface Loopback0\n+   description Nornir\n    ip address 5.5.5.5/32\n !\n interface Management1'
>>> 
>>> result['veos01'][7].result[0].changed
True
```

The description for the return for the NAPALM plugin was found [here](https://github.com/nornir-automation/nornir_napalm/blob/master/nornir_napalm/plugins/tasks/napalm_configure.py). 


Last thing to point out is that, using the Aggregrated result, you can quickly see what hosts failed at a task:

```python
>>> result.failed_hosts
{}
>>> 
```

Any failed hosts will show up in that dictionary. To see if any host failed at a task, you can also use the following:

```
>>> result['veos01'].failed
False
>>> 
```

# Final thoughts

Developing automations with Nornir is a lot of fun. The main things I like about it is how minimal it is and the fact that Nornir let's you do the thing you want to do in the way you want to. 

It takes care of the inventory and let's you run tasks against devices, but it does not  impose. It is lightweight and fast, but does not ask for much in terms of memory or CPU.

If you like working on network automation using Python, Nornir is definitely something to consider.